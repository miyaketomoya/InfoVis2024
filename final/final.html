<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>都道府県別 日本人人口・性比の比較 (2021 vs 2023)</title>
  <!-- D3.js の読み込み -->
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1 { text-align: center; }
    .chart { margin: 40px auto; max-width: 900px; }
    /* 棒グラフ用 */
    .bar { opacity: 0.9; }
    .bar:hover { opacity: 0.7; }
    /* 散布図用 */
    .scatter-circle { fill: teal; cursor: pointer; }
    .scatter-circle:hover { stroke: red; stroke-width: 1.5px; }
    .axis text { font-size: 12px; }
    .legend rect { stroke: #000; stroke-width: 0.5px; }
  </style>
</head>
<body>
  <h1>都道府県別 日本人人口・性比の比較 (2021 vs 2023)</h1>
  <!-- グループ化棒グラフ（総人口） -->
  <div id="bar-chart" class="chart"></div>
  <!-- 散布図（人口性比） -->
  <div id="scatter-plot" class="chart"></div>
  
  <script>
    // CSV の元データのうち、必要な列のみを抜き出す関数
    // 元の CSV は d3.text() で読み込み、d3.csvParseRows で行列形式に変換する
    // ※元の列のインデックスは以下のとおり：
    // 0:"時間軸（年月日現在） コード",1:"時間軸（年月日現在） 補助コード",2:"時間軸（年月日現在）",
    // 3:"全国・都道府県 コード",4:"全国・都道府県 補助コード",5:"全国・都道府県",
    // 6:"/男女別・性比",
    // 7:"男女計【千人】"（全体用）,8:"男【千人】",9:"女【千人】",10:"人口性比【女性＝100】",
    // 11:"男女計【千人】"（日本人人口用）,12:"男【千人】",13:"女【千人】",14:"人口性比【女性＝100】"
    // 新しいヘッダーで使うのは、インデックス 5, 11, 12, 13, 14 の列
    function loadAndProcess(url) {
      return d3.text(url).then(function(text) {
        let rows = d3.csvParseRows(text);
        // 新しいヘッダー
        const newHeader = ["prefecture", "pop_jpn", "male_jpn", "female_jpn", "ratio_jpn"];
        // 新しい行：1行目に新ヘッダー、2行目以降は必要な列のみ抽出
        let newRows = rows.map(function(row, i) {
          if(i === 0) return newHeader;
          return [ row[5], row[11], row[12], row[13], row[14] ];
        });
        // CSV 形式のテキストに変換してからオブジェクト配列にパース
        let data = d3.csvParse(d3.csvFormat(newRows));
        // 数値の前処理（カンマ除去＆数値変換）
        data.forEach(function(d) {
          d.pop_jpn = +d.pop_jpn.replace(/,/g, "");
          d.male_jpn = +d.male_jpn.replace(/,/g, "");
          d.female_jpn = +d.female_jpn.replace(/,/g, "");
          d.ratio_jpn = +d.ratio_jpn;
        });
        return data;
      });
    }
    
    // 2021年版と2023年版の CSV を同時に読み込む
    Promise.all([
      loadAndProcess("https://miyaketomoya.github.io/InfoVis2024/final/population_2021.csv"),
      loadAndProcess("https://miyaketomoya.github.io/InfoVis2024/final/population_2023.csv")
    ]).then(function([data2021, data2023]) {
      
      // 都道府県ごとにデータを統合（例："全国" など不要な行は除外）
      let dataMap = {};
      data2021.forEach(function(d) {
        dataMap[d.prefecture] = {
          prefecture: d.prefecture,
          pop2021: d.pop_jpn,
          ratio2021: d.ratio_jpn
        };
      });
      data2023.forEach(function(d) {
        let pref = d.prefecture;
        if(dataMap[pref]){
          dataMap[pref].pop2023 = d.pop_jpn;
          dataMap[pref].ratio2023 = d.ratio_jpn;
        } else {
          dataMap[pref] = {
            prefecture: pref,
            pop2023: d.pop_jpn,
            ratio2023: d.ratio_jpn
          };
        }
      });
      
      // 配列に変換し、「全国」など不要な行は除外
      let mergedData = Object.values(dataMap).filter(d => d.prefecture !== "全国");
      
      // ──────────────
      // ① グループ化棒グラフ（総人口の比較：2021 vs 2023）
      // ──────────────
      const marginBar = { top: 20, right: 20, bottom: 120, left: 60 },
            widthBar = 900 - marginBar.left - marginBar.right,
            heightBar = 500 - marginBar.top - marginBar.bottom;
      
      const svgBar = d3.select("#bar-chart")
                       .append("svg")
                       .attr("width", widthBar + marginBar.left + marginBar.right)
                       .attr("height", heightBar + marginBar.top + marginBar.bottom)
                       .append("g")
                       .attr("transform", `translate(${marginBar.left},${marginBar.top})`);
      
      // x0: 都道府県ごとのグループ
      const x0 = d3.scaleBand()
                   .domain(mergedData.map(d => d.prefecture))
                   .range([0, widthBar])
                   .paddingInner(0.2);
      
      // x1: 同一グループ内で 2021 と 2023 の棒を配置
      const x1 = d3.scaleBand()
                   .domain(["2021", "2023"])
                   .range([0, x0.bandwidth()])
                   .padding(0.05);
      
      // y 軸：総人口（千人）の最大値
      const yBar = d3.scaleLinear()
                     .domain([0, d3.max(mergedData, d => Math.max(d.pop2021, d.pop2023))])
                     .nice()
                     .range([heightBar, 0]);
      
      // カラー設定
      const color = d3.scaleOrdinal()
                      .domain(["2021", "2023"])
                      .range(["steelblue", "darkorange"]);
      
      // x 軸の描画
      svgBar.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${heightBar})`)
            .call(d3.axisBottom(x0))
            .selectAll("text")
            .attr("transform", "rotate(-45)")
            .style("text-anchor", "end");
      
      // y 軸の描画
      svgBar.append("g")
            .attr("class", "y-axis")
            .call(d3.axisLeft(yBar));
      
      // 各都道府県グループごとに棒を描画
      const groups = svgBar.selectAll(".pref-group")
                           .data(mergedData)
                           .enter()
                           .append("g")
                           .attr("class", "pref-group")
                           .attr("transform", d => `translate(${x0(d.prefecture)},0)`);
      
      groups.selectAll("rect")
            .data(d => [
              { year: "2021", value: d.pop2021 },
              { year: "2023", value: d.pop2023 }
            ])
            .enter()
            .append("rect")
            .attr("x", d => x1(d.year))
            .attr("y", d => yBar(d.value))
            .attr("width", x1.bandwidth())
            .attr("height", d => heightBar - yBar(d.value))
            .attr("fill", d => color(d.year))
            .attr("class", "bar")
            .on("mouseover", function(event, d) {
              d3.select(this).attr("opacity", 0.7);
            })
            .on("mouseout", function(event, d) {
              d3.select(this).attr("opacity", 0.9);
            });
      
      // 凡例（レジェンド）の追加
      const legend = svgBar.selectAll(".legend")
                           .data(["2021", "2023"])
                           .enter()
                           .append("g")
                           .attr("class", "legend")
                           .attr("transform", (d, i) => `translate(${i * 100}, -20)`);
      
      legend.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 15)
            .attr("height", 15)
            .attr("fill", d => color(d));
      
      legend.append("text")
            .attr("x", 20)
            .attr("y", 12)
            .text(d => d);
      
      // ──────────────
      // ② 散布図（人口性比の比較：2021 vs 2023）
      // ──────────────
      const marginScatter = { top: 20, right: 20, bottom: 50, left: 60 },
            widthScatter = 500 - marginScatter.left - marginScatter.right,
            heightScatter = 500 - marginScatter.top - marginScatter.bottom;
      
      const svgScatter = d3.select("#scatter-plot")
                           .append("svg")
                           .attr("width", widthScatter + marginScatter.left + marginScatter.right)
                           .attr("height", heightScatter + marginScatter.top + marginScatter.bottom)
                           .append("g")
                           .attr("transform", `translate(${marginScatter.left},${marginScatter.top})`);
      
      // x 軸：2021年の人口性比
      const xScatter = d3.scaleLinear()
                         .domain([
                           d3.min(mergedData, d => d.ratio2021) - 5,
                           d3.max(mergedData, d => d.ratio2021) + 5
                         ])
                         .range([0, widthScatter]);
      
      // y 軸：2023年の人口性比
      const yScatter = d3.scaleLinear()
                         .domain([
                           d3.min(mergedData, d => d.ratio2023) - 5,
                           d3.max(mergedData, d => d.ratio2023) + 5
                         ])
                         .range([heightScatter, 0]);
      
      // x 軸の描画
      svgScatter.append("g")
                .attr("transform", `translate(0,${heightScatter})`)
                .call(d3.axisBottom(xScatter));
      
      // y 軸の描画
      svgScatter.append("g")
                .call(d3.axisLeft(yScatter));
      
      // 軸ラベル
      svgScatter.append("text")
                .attr("x", widthScatter / 2)
                .attr("y", heightScatter + marginScatter.bottom - 5)
                .attr("text-anchor", "middle")
                .text("人口性比【女性＝100】 (2021)");
      
      svgScatter.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -heightScatter / 2)
                .attr("y", -marginScatter.left + 15)
                .attr("text-anchor", "middle")
                .text("人口性比【女性＝100】 (2023)");
      
      // 各都道府県の点を描画
      svgScatter.selectAll("circle")
                .data(mergedData)
                .enter()
                .append("circle")
                .attr("class", "scatter-circle")
                .attr("cx", d => xScatter(d.ratio2021))
                .attr("cy", d => yScatter(d.ratio2023))
                .attr("r", 5)
                .on("mouseover", function(event, d) {
                  d3.select(this).attr("r", 7);
                })
                .on("mouseout", function(event, d) {
                  d3.select(this).attr("r", 5);
                });
      
      // 参考：x = y の対角線
      svgScatter.append("line")
                .attr("x1", 0)
                .attr("y1", heightScatter)
                .attr("x2", widthScatter)
                .attr("y2", 0)
                .attr("stroke", "gray")
                .attr("stroke-dasharray", "4");
    });
  </script>
</body>
</html>
